<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小狗创作中</title>
    <style>
        body { font-family: Arial, sans-serif; background: #fff; text-align: center; }
        h1 { font-size: 24px; }
        .clock { position: absolute; top: 10px; left: 10px; font-size: 16px; }
        .counter { position: absolute; top: 10px; right: 10px; font-size: 16px; }
        .nav { margin: 20px 0; }
        .nav button { padding: 5px 10px; margin: 5px; border: 1px solid #ddd; background: #f8f8f8; cursor: pointer; }
        .subcategory { display: none; margin-top: 5px; }
        .subcategory button { background: #e0e0e0; }
        .post { border-bottom: 1px solid #ddd; padding: 10px; margin: 10px auto; width: 80%; max-width: 600px; text-align: left; }
        .post h2 { font-size: 18px; }
        .post p { white-space: pre-line; }
        .hidden { display: none; }
        .footer { margin-top: 20px; font-size: 14px; color: gray; }
    </style>
</head>
<body>
    <div class="clock" id="clock">时间加载中...</div>
    <div class="counter">访问量：<span id="viewCount">加载中...</span></div>
    <h1>小狗创作中</h1>

    <!-- **导航栏（大分类 & 小分类）** -->
    <div class="nav" id="nav"></div>

    <h2>最新作品</h2>
    <div id="content">加载中...</div>

    <!-- **图片上传区域** -->
    <h2>上传图片（自动添加水印）</h2>
    <input type="file" id="imageUpload" accept="image/*">
    <canvas id="canvas" style="display:none;"></canvas>
    <br>
    <button onclick="downloadImage()">下载带水印的图片</button>

    <!-- **底部邮箱** -->
    <div class="footer">联系方式：oloiyy@163.com</div>

    <script>
        // **时钟**
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString();
        }
        setInterval(updateClock, 1000);
        updateClock();

        // **访问计数**
        if (!localStorage.viewCount) localStorage.viewCount = 0;
        localStorage.viewCount = parseInt(localStorage.viewCount) + 1;
        document.getElementById('viewCount').textContent = localStorage.viewCount;

        // **大分类和小分类数据**
        const categories = {
            "小说-同人": ["成小玉"],
            "小说-原创": [],
            "小说-稿件": [],
            "画画-同人": [],
            "画画-原创": [],
            "画画-自设": [],
            "画画-稿件": [],
            "画画-课程跟画": [],
            "画画-水印": []
        };

        // **加载导航栏**
        function loadNavigation() {
            const navDiv = document.getElementById("nav");
            navDiv.innerHTML = "";

            for (const [mainCategory, subCategories] of Object.entries(categories)) {
                const mainBtn = document.createElement("button");
                mainBtn.textContent = mainCategory;
                mainBtn.onclick = () => toggleSubcategories(mainCategory);
                navDiv.appendChild(mainBtn);

                if (subCategories.length > 0) {
                    const subDiv = document.createElement("div");
                    subDiv.classList.add("subcategory");
                    subDiv.id = `sub-${mainCategory}`;

                    subCategories.forEach(sub => {
                        const subBtn = document.createElement("button");
                        subBtn.textContent = sub;
                        subBtn.onclick = () => filterPosts(sub);
                        subDiv.appendChild(subBtn);
                    });

                    navDiv.appendChild(subDiv);
                }
            }
        }

        // **切换小分类**
        function toggleSubcategories(category) {
            document.querySelectorAll(".subcategory").forEach(sub => sub.style.display = "none");
            const targetSub = document.getElementById(`sub-${category}`);
            if (targetSub) targetSub.style.display = "block";
            filterPosts(category);
        }

        // **获取 GitHub Issues（按标签筛选）**
        async function fetchIssues() {
            const username = "joinliving";
            const repo = "puppy";
            const url = `https://api.github.com/repos/${username}/${repo}/issues?state=open`;

            try {
                const response = await fetch(url);
                const issues = await response.json();
                const contentDiv = document.getElementById("content");
                contentDiv.innerHTML = "";

                issues.forEach(issue => {
                    const post = document.createElement("div");
                    post.classList.add("post");
                    post.dataset.tags = issue.labels.map(label => label.name).join(",");

                    post.innerHTML = `<h2>${issue.title}</h2><p>${issue.body.replace(/\n/g, "<br>")}</p>`;
                    contentDiv.appendChild(post);
                });

            } catch (error) {
                document.getElementById("content").textContent = "加载失败，请检查 GitHub 配置";
            }
        }
        fetchIssues();

        // **按分类筛选**
        function filterPosts(category) {
            document.querySelectorAll(".post").forEach(post => {
                post.style.display = category && !post.dataset.tags.includes(category) ? "none" : "block";
            });
        }

        // **图片上传并添加水印**
        document.getElementById("imageUpload").addEventListener("change", function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.getElementById("canvas");
                        const ctx = canvas.getContext("2d");

                        canvas.width = img.width;
                        canvas.height = img.height;

                        ctx.drawImage(img, 0, 0);
                        ctx.font = "30px Arial";
                        ctx.fillStyle = "rgba(255, 0, 0, 0.5)";
                        ctx.fillText("山雀大王", 20, 50);
                        ctx.fillText("oloiyy@163.com", 20, 90);

                        canvas.style.display = "block";
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        // **下载带水印的图片**
        function downloadImage() {
            const canvas = document.getElementById("canvas");
            const link = document.createElement("a");
            link.download = "watermarked_image.png";
            link.href = canvas.toDataURL();
            link.click();
        }

        // **初始化**
        loadNavigation();
    </script>
</body>
</html>